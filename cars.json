(function(){
  const SHOP_DOMAIN = 'www.kn-goodcar.com';
  const TOKEN = 'bb70cb008199a94b83c98df0e45ada67';

  // GraphQL Query: ดึงรถ 10 คันล่าสุด (เพิ่ม field ได้)
  const query = `
    {
      products(first: 10, sortKey: CREATED_AT, reverse: true) {
        edges {
          node {
            title
            handle
            images(first:1) { edges { node { url } } }
            variants(first:1) { edges { node { priceV2 { amount } } } }
          }
        }
      }
    }
  `;

  // ดึงข้อมูลจาก Shopify API
  fetch(`https://${SHOP_DOMAIN}/api/2023-07/graphql.json`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Shopify-Storefront-Access-Token": TOKEN
    },
    body: JSON.stringify({ query })
  })
  .then(res => res.json())
  .then(({ data }) => {
    if(!data || !data.products) return;

    data.products.edges.forEach(({ node }) => {
      // Mapping อัตโนมัติเป็น JSON-LD
      const jsonld = {
        "@context": "https://schema.org",
        "@type": "Product",
        "name": node.title,
        "image": node.images.edges[0]?.node.url || "",
        "description": `${node.title} มือสอง สภาพเยี่ยม ฟรีดาวน์ ผ่อนสบาย`,
        "brand": { "@type": "Brand", "name": node.title.split(' ')[0] || "" },
        "model": (node.title.split(' ')[1] || ""),
        "offers": {
          "@type": "Offer",
          "price": node.variants.edges[0]?.node.priceV2.amount || "",
          "priceCurrency": "THB",
          "availability": "https://schema.org/InStock",
          "priceValidUntil": "2025-12-31",
          "url": `https://${SHOP_DOMAIN}/products/${node.handle}`
        },
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "4.9",
          "reviewCount": "20"
        },
        "review": [
          {
            "@type": "Review",
            "author": "ลูกค้าจริง",
            "reviewRating": { "@type": "Rating", "ratingValue": "5" },
            "reviewBody": "รถสวย ตรงปก บริการดีมาก"
          }
        ]
      };

      // Inject JSON-LD script เข้า <head> ทันที
      const s = document.createElement('script');
      s.type = 'application/ld+json';
      s.text = JSON.stringify(jsonld);
      document.head.appendChild(s);
    });
  })
  .catch(err => {
    console.error("Shopify API/JSON-LD Error:", err);
  });
})();